pipeline {
    agent any

    environment {
        SSH_CRED_ID = 'deployment-key'
        // I have pre-filled your actual Repo URL based on your logs
        YOUR_REPO_URL = 'https://github.com/0mBarde/3-tier-app.git'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Security: Infra (Checkov)') {
            steps {
                dir('infra') {
                    // Soft-fail ensures the build doesn't stop, but you see the security report
                    sh 'checkov -d . --soft-fail' 
                }
            }
        }

        stage('Provision: App Infrastructure') {
            steps {
                dir('infra') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                    // Save IPs to files so we can use them in the next stage
                    sh 'terraform output -raw app_private_ip > ../app_ip.txt'
                    sh 'terraform output -raw web_private_ip > ../web_ip.txt'
                }
            }
        }

        stage('Security: App (Trivy)') {
            steps {
                echo "Scanning Backend Code..."
                sh 'trivy fs app/ --scanners vuln --severity HIGH,CRITICAL'
                
                echo "Scanning Frontend Code..."
                sh 'trivy fs frontend/ --scanners vuln --severity HIGH,CRITICAL'
            }
        }

        stage('Deploy: Update App') {
            steps {
                script {
                    def APP_IP = readFile('app_ip.txt').trim()
                    def WEB_IP = readFile('web_ip.txt').trim()
                    
                    sshagent(credentials: [SSH_CRED_ID]) {
                        
                        // --- 1. DEPLOY TO APP SERVER (BACKEND) ---
                        echo "Deploying to App Server (${APP_IP})..."
                        sh """
                            ssh -o StrictHostKeyChecking=no ec2-user@${APP_IP} '
                                # ROBUSTNESS LOOP: Wait up to 3 mins for setup.sh to finish
                                echo "Checking if App folder exists..."
                                for i in {1..18}; do
                                    if [ -d "/home/ec2-user/3-tier-app" ]; then
                                        echo "App folder found! Proceeding..."
                                        break
                                    fi
                                    echo "Waiting for setup.sh to complete... (Attempt \$i/18)"
                                    sleep 10
                                done
                                
                                # FIX PERMISSIONS (Root owned it, we need ec2-user to own it)
                                sudo chown -R ec2-user:ec2-user /home/ec2-user/3-tier-app
                                git config --global --add safe.directory /home/ec2-user/3-tier-app
                                
                                # UPDATE CODE
                                cd 3-tier-app
                                git remote set-url origin ${YOUR_REPO_URL}
                                git fetch origin
                                git reset --hard origin/main
                                
                                # RESTART APP
                                pip3 install -r app/requirements.txt
                                sudo systemctl restart backend
                            '
                        """
                        
                        // --- 2. DEPLOY TO WEB SERVER (FRONTEND) ---
                        echo "Deploying to Web Server (${WEB_IP})..."
                        sh """
                            ssh -o StrictHostKeyChecking=no ec2-user@${WEB_IP} '
                                # ROBUSTNESS LOOP
                                echo "Checking if App folder exists..."
                                for i in {1..18}; do
                                    if [ -d "/home/ec2-user/3-tier-app" ]; then
                                        echo "App folder found! Proceeding..."
                                        break
                                    fi
                                    echo "Waiting for setup.sh to complete... (Attempt \$i/18)"
                                    sleep 10
                                done
                                
                                # FIX PERMISSIONS
                                sudo chown -R ec2-user:ec2-user /home/ec2-user/3-tier-app
                                git config --global --add safe.directory /home/ec2-user/3-tier-app
                                
                                # UPDATE CODE
                                cd 3-tier-app
                                git remote set-url origin ${YOUR_REPO_URL}
                                git fetch origin
                                git reset --hard origin/main
                                
                                # RESTART APP
                                pip3 install -r frontend/requirements.txt
                                sudo systemctl restart frontend
                            '
                        """
                    }
                }
            }
        }
    }
}
